upstream vote_up   { server vote:80; }
upstream result_up { server result:80; }

server {
  listen 80;
  server_name _;
  client_max_body_size 10m;

  location /healthz {
    return 200 'ok';
    add_header Content-Type text/plain;
  }

  # Vote at /
  location / {
    proxy_pass http://vote_up;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }

  # Result under /result/ (strip prefix)
  location /result/ {
    rewrite ^/result/(.*)$ /$1 break;
    proxy_pass http://result_up;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }

  # Result assets / websockets that use absolute paths
  location /socket.io/ {
    proxy_pass http://result_up/socket.io/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }
  location = /app.js    { proxy_pass http://result_up/app.js; }
  location = /style.css { proxy_pass http://result_up/style.css; }
}
